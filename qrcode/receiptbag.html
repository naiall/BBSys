<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blood Bag Confirmation</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div id="responseOutput"></div>

    <script>
        // Replace these PHP placeholders with actual server-side data
        const bo = '<?= bo; ?>';
        const bt = '<?= bt; ?>';
        const name_ = '<?= databb.name; ?>';
        const ward_ = '<?= data.ward; ?>';
        const userId = '<?= User_ID; ?>';
        const name_rec = '<?= data.name; ?>';
        const hn = '<?= databb.hn; ?>';           
        const group_ = '<?= databb.abo; ?>';
        const rh_ = '<?= databb.rh; ?>';                

        // Generate the current formatted date for submission
        const today = new Date();
        const day = String(today.getDate()).padStart(2, '0');
        const month = String(today.getMonth() + 1).padStart(2, '0'); // Month starts from 0
        const year = today.getFullYear() + 543; // Adjust year to Buddhist calendar

        const formattedDate = `${day}/${month}/${year}`;        

        Swal.fire({
            title: 'ยืนยันการรับเลือด?',
            html: `
                <div style="text-align: left;">
                    <table style="width: 100%; border-collapse: collapse; text-align: left;">
                        <tr style="background-color: #f2f2f2;">
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>BO</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${bo}</td>
                        </tr>
                        <tr style="background-color: #ffffff;">
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>BT</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; font-size: 1em;">${bt}</td>
                        </tr>
                        <tr style="background-color: #f2f2f2;">
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Name</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${name_}</td>
                        </tr>
                        <tr style="background-color: #ffffff;">
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>HN</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${hn}</td>
                        </tr>
                        <tr style="background-color: #f2f2f2;">
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Group</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; font-size: 2em; color: ${
                                group_ === 'O' ? 'black' : group_ === 'A' ? 'black' : group_ === 'B' ? 'pink' : 'black'
                            }">
                                ${group_}
                            </td>
                        </tr>
                        <tr style="background-color: #ffffff;">
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Rh</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${rh_}</td>
                        </tr>                                             
                    </table>
                </div>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'รับเลือด',
            cancelButtonText: 'ยกเลิก'
         }).then((result) => {
            if (result.isConfirmed) {
                // Send data to Google Apps Script
                fetch('https://script.google.com/macros/s/AKfycbwfMdrvJkb_Rd2zGKBlyI99XfK6qruMe2-ADfNAEIsbShf9E6agNxeBzU_x9EvJJt-R/exec', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        method: 'edit',
                        bo: bo,
                        bt: bt,
                        receive_name: name_rec,
                        receive_ward: ward_,
                        receive_dt: formattedDate
                    }),
                })
                .then(response => response.text())
                .then(data => {
                    document.getElementById('responseOutput').textContent = data;

                    // Show success SweetAlert
                    Swal.fire({
                        icon: 'success',
                        title: 'ส่งข้อมูลสำเร็จ!',
                        text: 'ข้อมูลได้ถูกส่งเรียบร้อยแล้ว',
                    }).then(() => {
                        window.close(); // Close the current tab
                    });

                    // Call sendToLineBotZZ function
                    sendToLineBotZZ(bo, bt, name_, name_rec, group_, rh_, userId, ward_, hn);
                })
                .catch(error => {
                    document.getElementById('responseOutput').textContent = 'Error: ' + error;

                    // Show error SweetAlert
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: 'ไม่สามารถส่งข้อมูลได้',
                    });
                });
            }
        });

        // Define the function to call the LINE Bot directly
        function sendToLineBotZZ(bo, bt, name, namerec, abo, rh, userId, hn, ward_) {
            fetch('https://script.google.com/macros/s/AKfycbxKTile0eqVDlq17vBNE32_TseqgLYRY9BvQj9Fa5MTkTn6fCYyMhXGdvbKmznHyF4I/exec', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    method: 'sendToLineBot',
                    bo: bo,
                    bt: bt,
                    name: name,
                    namerec: namerec,
                    abo: abo,
                    rh: rh,
                    userId: userId,
                    hn: hn,
                    ward_: ward_
                }),
            })
            .then(response => response.text())
            .then(data => console.log('Sent to LINE Bot:', data))
            .catch(error => console.error('Error:', error));
        }
    </script>
</body>
</html>
