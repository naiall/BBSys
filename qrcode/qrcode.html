<script>
    // Function to extract query parameters from URL
    function getQueryParams() {
        const params = {};
        const queryString = window.location.search.substring(1);
        const pairs = queryString.split("&");
        for (let i = 0; i < pairs.length; i++) {
            const pair = pairs[i].split("=");
            params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
        }
        return params;
    }

    // Extract parameters and set user info
    const params = getQueryParams();
    const userId = params.userId || "N/A"; 
    const displayName = params.displayName || "N/A"; 

    document.getElementById("userId").textContent = userId;
    document.getElementById("displayName").textContent = displayName;

    // Initialize QR code scanner on document ready
    function docReady(fn) {
        if (document.readyState === "complete" || document.readyState === "interactive") {
            setTimeout(fn, 1);
        } else {
            document.addEventListener("DOMContentLoaded", fn);
        }
    }

    docReady(function() {
        const html5QrcodeScanner = new Html5QrcodeScanner("qr-reader", { fps: 10, qrbox: 250 });
        let pendingResult = null;

        // Handle scan success
        function onScanSuccess(decodedText, decodedResult) {
            if (!pendingResult) {
                pendingResult = decodedText;

                // Show SweetAlert with "กรุณารอ" message
                Swal.fire({
                    title: 'กรุณารอ',
                    text: 'กำลังส่งข้อมูล...',
                    icon: 'info',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    didOpen: () => {
                        Swal.showLoading(); // Show loading animation
                    }
                });

                // Automatically submit the scan result after showing the alert
                setTimeout(() => {
                    const boBtValue = pendingResult;
                    const submitUrl = `${boBtValue}&userId=${userId}&displayName=${encodeURIComponent(displayName)}`;
                    window.location.href = submitUrl;
                }, 2000); // Delay submission for 2 seconds
            }
        }

        // Render the QR scanner
        html5QrcodeScanner.render(onScanSuccess, () => {});

        // Start QR code scanning with the back camera
        const html5QrCode = new Html5Qrcode("qr-reader");
        const config = { fps: 10, qrbox: 250 };
        const qrCodeSuccessCallback = onScanSuccess;

        html5QrCode.start(
            { facingMode: { exact: "environment" } }, // Use back camera
            config,
            qrCodeSuccessCallback
        ).catch(err => {
            console.error("Error starting QR code scanner:", err);
        });
    });
</script>
